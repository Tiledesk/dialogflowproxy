<html>

<head>
	<link rel="stylesheet" href="/home/uni21-widget-design.component.css" media="screen" />
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script src="/js/Autolinker.js"></script>
	<script>
		$(function () {
			hideLogin();
			var action_url = $("#chat21-form-container").attr('action');
			console.log("form action: ", action_url);
			activateButtons(false);
			$('#uni21-privacy-checkbox').click(function () {
				activateButtons(this.checked);
			});
			$("#choose_anonymous_btn").click(function () {
				window.tiledesk.setStatePreChatForm(true);
				window.tiledesk.signInAnonymous();
				hideLogin();
				showWidget();
				return false;
			});
			$("#uni21-launcher-button-open").click(function () {
				$("#uni21-conversations").show();
				$("#uni21-launcher-button-open").hide();
				$("#uni21-launcher-button-closed").show();
			});
			$("#uni21-launcher-button-closed").click(function () {
				$("#uni21-conversations").hide();
				$("#uni21-launcher-button-closed").hide();
				$("#uni21-launcher-button-open").show();
			});
			$(".uni21-header-button").click(function () {
				$("#uni21-conversations").hide();
				$("#uni21-launcher-button-closed").hide();
				$("#uni21-launcher-button-open").show();
			});
			$("#choose_login_btn").click(function () {
				$("#chat21-form-container").show();
				$("#choose-option-container").hide();
				$("#back-button").show();
			});
			$("#back-button").click(function () {
				$("#chat21-form-container").hide();
				$("#choose-option-container").show();
				$("#back-button").hide();
			});
			$("#submit_btn").click(function () {
				var dataString = $("#chat21-form-container").serialize();
				console.log("form data: ", dataString);
				$("#submit_btn").prop("disabled", "disabled");
				$("#submit_btn_content").html('Autenticazione in corso...');
				$("#anonymous_btn").hide();
				$.ajax({
					type: "POST",
					url: action_url,
					data: dataString,
					dataType: 'json',
					success: function (json) {
						console.log("Success. JWT: ", json.jwt);
						// alert("Autenticazione avvenuta con successo");
						window.tiledesk.signInWithCustomToken(json.jwt);
						window.tiledesk.setStatePreChatForm(false);
						hideLogin();
						resetButtons();
						showWidget();
					},
					error: function (xhr, ajaxOptions, thrownError) {
						console.log("error.");
						console.log(xhr.status);
						console.log(thrownError);
						$("#submit_btn").removeAttr('disabled');
						$("#anonymous_btn").show();
						alert("Errore Autenticazione.");
					}
				});
				return false;
			});
		});

		function activateButtons(checked) {
			var enabled_css = { 'background-color': 'rgb(223, 122, 106)', 'border-color': 'rgb(223, 122, 106)', 'color': '#fff' };
			var disabled_css = { 'background-color': 'rgb(200, 200, 200)', 'border-color': 'rgb(200, 200, 200)', 'color': '#fff' };

			if (checked) {
				$("#submit_btn").removeAttr('disabled');
				$("#anonymous_btn").removeAttr('disabled');
				$("#submit_btn").css(enabled_css);
				$("#anonymous_btn").css(enabled_css);
			}
			else {
				$("#submit_btn").prop("disabled", "disabled");
				$("#anonymous_btn").prop("disabled", "disabled");
				$("#submit_btn").css(disabled_css);
				$("#anonymous_btn").css(disabled_css);
			}
		}

		function resetButtons() {
			$("#submit_btn").removeAttr('disabled');
			$("#submit_btn_content").html('Login');
			$("#anonymous_btn").show();
		}

		function hideLogin() {
			$("#uni21-launcher-button-open").hide();
			$("#uni21-launcher-button-closed").hide();
			$("#uni21-container").hide();
		}

		function showLogin() {
			$("#uni21-launcher-button-open").show();
			$("#uni21-launcher-button-closed").hide();
			$("#uni21-container").show();
		}

		function showWidget() {
			// alert("show widget");
			window.tiledesk.show();
			window.tiledesk.open();
		}
	</script>

	<script type="application/javascript">
		window.tiledeskSettings =
			{
				projectid: "5c1a88cd3ae3e5001559d3fb", // bari
				preChatForm: false,
				calloutTimer: -1,
				align: 'right',
				startHidden: false,
				autoStart: true,
				wellcomeTitle: 'Benvenuto su Comune di Bari',
				wellcomeMsg: "Come possiamo aiutarti?",
				logoChat: "/home/comunebarilogo.png",
				startFromHome: true
			};
		(function (d, s, id) {
			var js, fjs = d.getElementsByTagName(s)[0];
			if (d.getElementById(id)) return;
			js = d.createElement(s); js.id = id; //js.async=!0;
			js.src = "https://widget.tiledesk.com/v2/tiledesk.js";
			fjs.parentNode.insertBefore(js, fjs);
		}(document, 'script', 'tiledesk-jssdk'));

		window.tileDeskAsyncInit = function () {
			console.log("window.tileDeskAsyncInit()");
			// window.tiledesk.on('isLoggedIn', function (loggedIn) {
			// 	var islogged = loggedIn.detail;
			// 	console.log("window.tiledesk.on LoggedIn ", islogged);
			// 	if (!islogged) {
			// 		console.log("ShowLogin");
			// 		showLogin();
			// 		window.tiledesk.hide();
			// 	}
			// 	else {
			// 		console.log("HideLogin");
			// 		hideLogin();
			// 		window.tiledesk.show();
			// 		window.tiledesk.open();
			// 	}
			// });

			window.tiledesk.on('afterMessageRender', function (event_data) {
				// console.log("event_data", event_data);
				var message = event_data.detail.message;
				var messageEl = event_data.detail.messageEl;
				var component = event_data.detail.component;
				var text = message.text;
				if (text.indexOf("-- Puoi rispondere:") != -1 && messageEl.innerHTML.indexOf("box") == -1) {
					var parts = text.split("-- Puoi rispondere:");
					var len = parts.length;
					var new_text = Autolinker.link(parts[0],{stripPrefix:false});
					var innerHTML = new_text +
						`<br><br><div class="box">`;
					var options = parts[1].split(",");
					var button_id_prefix = "buttonSendMessageFromComponent";
					for (var i = 0; i < options.length; i++) {
						var button_text = option_to_text_message(options[i].trim());
						var button = `<button type="button" id="${button_id_prefix}-${message.uid}-${i}">${button_text}</button>`;
						innerHTML = innerHTML + button;
					}
					innerHTML = innerHTML + `<div>`;
					messageEl.innerHTML = innerHTML;
					for (var i = 0; i < options.length; i++) {
						var buttonSendMessageFromComponent = document.getElementById(button_id_prefix + "-" + message.uid + "-" + i);
						console.log("buttonSendMessageFromComponent" + buttonSendMessageFromComponent);
						buttonSendMessageFromComponent.addEventListener('click', function (e) {
							var button_text = e.target.innerHTML;
							console.log("button_text: " + button_text);
							var option_menu_message = message_to_button_text(button_text);
							console.log("option_menu_message: " + option_menu_message);
							component.sendMessage(option_menu_message, "text");
						});
					}
					window.tiledesk.endMessageRender();
				}
				else {
					if (messageEl.innerHTML.indexOf("box") == -1) {
						var innerHTML = `<div class="box">`
						var message_text_without_underscores = text.replace(/_/g, " ");
						var linked_text = Autolinker.link(message_text_without_underscores,{stripPrefix:false});
						innerHTML = innerHTML + linked_text;
						innerHTML = innerHTML + `<div>`;
						messageEl.innerHTML = innerHTML
						window.tiledesk.endMessageRender();
					}
				}
			});
			
			function option_to_text_message(text) {
				return text.replace(/_/g, " ");
			}

			function message_to_button_text(text) {
				return text.replace(/ /g, "_");
			}
		}



	</script>

	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
</head>

<body>
	<img style="width: 100%;" src="/home/sitehome.jpg">

	<div id="uni21-container">
		<div class="uni21-window uni21-sheet" id="uni21-conversations" style="display: none;">
			<div class="uni21-sheet-header" style="background-color: rgb(238, 116, 100);">

				<div class="uni21-sheet-header-title-container">
					<b class="uni21-sheet-header-title" style="color: rgb(255, 255, 255);">
						<span>Comune di Bari</span>
					</b>
				</div>

				<a>
					<div class="uni21-header-button right">
						<svg aria-labelledby="altIconTitle" height="24px" role="img" viewBox="0 0 24 24" width="100%" xmlns="http://www.w3.org/2000/svg"
						 style="fill: rgb(255, 255, 255);">
							<path d="M0 0h24v24H0V0z" fill="none"></path>
							<path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"></path>
							<title id="altIconTitle"></title>
						</svg>
					</div>
				</a>
			</div>

			<div class="uni21-sheet-content" id="uni21-sheet-content">
				<div class="uni21-conversation-parts-container" style="height:100%; overflow-y: hidden;">
					<div id="scroll-me" style="height:100%; overflow-y:auto;">

						<div id="uni21-contentScroll">

							<div id="back-button" style="display: none; padding-left: 30px; font-size: 14px; color: blue; font-family: system-ui;">&lt;Indietro</div>

							<div id="choose-option-container" style="margin: auto;text-align: center;">
								<button class="c21-button-primary" id="choose_login_btn" style="background-color: rgb(223, 122, 106), border-color: rgb(223, 122, 106), color: #fff">
									<span class="v-align-center c21-label-button">Autenticati</span>
									<div class="clear"></div>
								</button>
								<br>
								<button class="c21-button-primary" id="choose_anonymous_btn" style="background-color: rgb(223, 122, 106), border-color: rgb(223, 122, 106), color: #fff">
									<span class="v-align-center c21-label-button">Prosegui anonimo</span>
									<div class="clear"></div>
								</button>
							</div>


							<form id="chat21-form-container" action="/login" style="display: none">
								<span style="color: #000; font-size: 1.3em; font-weight: bold;">Email Comune di Bari:</span>
								<div class="text-danger">
									<small>
										&nbsp;
									</small>
								</div>
								<div class="c21-input-container">
									<input name="ldap_param_mail" type="text" id="form-field-name" formControlName="name" placeholder="Email">
								</div>
								<div class="text-danger">
									<small>
										&nbsp;
									</small>
								</div>
								<span style="color: #000; font-size: 1.3em; font-weight: bold;">La tua password:</span>
								<div class="text-danger">
									<small>
										&nbsp;
									</small>
								</div>
								<div class="c21-input-container">
									<input type="password" name="ldap_user_password" placeholder="Password">
								</div>
								<br><br>
								<!-- <input type="checkbox" id="uni21-remember-checkbox"> Ricordami
								<br><br> -->
								<button class="c21-button-primary" id="submit_btn" style="background-color: rgb(223, 122, 106); border-color: rgb(223, 122, 106); color: #fff">
									<span class="v-align-center c21-label-button"><span id="submit_btn_content">Login</span></span>
									<div class="clear"></div>
								</button>
								<!-- <button class="c21-button-primary" id="anonymous_btn" style="background-color: rgb(223, 122, 106); border-color: rgb(223, 122, 106); color: #fff">
																<span class="v-align-center c21-label-button"><span id="anonymous_btn_content">Prosegui anonimo</span></span>
																<div class="clear"></div>
															</button> -->
								<br><input type="checkbox" id="uni21-privacy-checkbox"> Dichiaro di aver letto e di accettare le norme
								sulla privacy
								<a href="https://www.tiledesk.com/privacy.html" target="_blank">GDPR Privacy Comune di Bari</a>
							</form>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- OPEN ICON -->
	<div id="uni21-launcher-button-open" style="background-color: rgb(238, 116, 100);">
		<div style="width:100%; height:100%; padding:0px; margin: 0px;">
			<svg role="img" style="fill: rgb(255, 255, 255)" xmlns="http://www.w3.org/2000/svg" width="100%" height="100%"
			 viewBox="0 0 90 90">
				<path fill="none" d="M0 0h24v24H0V0z" />
				<path d="M33.57,31A4.58,4.58,0,0,0,29,35.57V58.3a1.94,1.94,0,0,0,3.32,1.38l3-3a.29.29,0,0,1,.21-.09H56.43A4.58,4.58,0,0,0,61,52V35.57A4.58,4.58,0,0,0,56.43,31Z" />
			</svg>
		</div>
	</div>
	<!-- CLOSE ICON -->
	<div id="uni21-launcher-button-closed" style="display: none; background-color: rgb(238, 116, 100);">
		<div style="width:100%; height:100%; padding:0px; margin: 0px;">
			<svg role="img" style="fill: rgb(255, 255, 255)" xmlns="http://www.w3.org/2000/svg" width="100%" height="100%"
			 viewBox="0 0 90 90">
				<path fill="none" d="M0 0h24v24H0V0z" />
				<path class="cls-1" d="M54.92,37.08l-2-2L45,43l-7.92-7.92-2,2L43,45l-7.92,7.92,2,2L45,47l7.92,7.92,2-2L47,45Z" />
			</svg>
		</div>
	</div>

</html>